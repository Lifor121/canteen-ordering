# Canteen Ordering API

Бэкенд-сервис для системы заказов в столовой.

### Требования

- **Python 3.8+**
- **PostgreSQL** (или другая СУБД, поддерживаемая Django)
- **Git**

### Шаги по установке

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/Lifor121/canteen-ordering
    cd canteen-ordering
    ```

2.  **Создайте и активируйте виртуальное окружение:**
    - На Windows:
      ```bash
      python -m venv venv
      .\venv\Scripts\activate
      ```
    - На macOS/Linux:
      ```bash
      python3 -m venv venv
      source venv/bin/activate
      ```

3.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

4.  **Настройте переменные окружения:**
    - Создайте файл `.env` в корневой директории проекта, скопировав `.env.example` (если он есть) или создав его с нуля.
    - Заполните `.env` необходимыми данными. Как минимум, вам нужно указать настройки для подключения к базе данных.
      ```dotenv
      # Настройки базы данных (пример для PostgreSQL)
      DB_ENGINE=django.db.backends.postgresql
      DB_NAME=canteen_db
      DB_USER=user
      DB_PASSWORD=password
      DB_HOST=localhost
      DB_PORT=5432

      # Секретный ключ Django (сгенерируйте свой)
      SECRET_KEY='your-super-secret-key'

      # Режим отладки (True для разработки, False для продакшена)
      DEBUG=True
      ```
    > **Важно:** Убедитесь, что база данных с указанным именем (`canteen_db` в примере) существует в вашей СУБД.

5.  **Примените миграции базы данных:**
    Эта команда создаст все необходимые таблицы в вашей базе данных.
    ```bash
    python manage.py migrate
    ```

6.  **Создайте суперпользователя (опционально):**
    Это позволит вам получить доступ к административной панели Django.
    ```bash
    python manage.py createsuperuser
    ```

7.  **Запустите сервер для разработки:**
    ```bash
    python manage.py runserver
    ```

После выполнения этих шагов сервер будет доступен по адресу `http://127.0.0.1:8000`. Вы можете начать отправлять запросы к API, используя документацию ниже.

---

# Справка по работе с API

## Аутентификация

Система использует JWT-токены д��я аутентификации. После успешной регистрации или входа, токен доступа (`access_token`) устанавливается в `HttpOnly` cookie. Этот cookie автоматически прикрепляется ко всем последующим запросам, избавляя от необходимости вручную добавлять заголовок `Authorization`.


---

## Раздел для всех пользователей

### 1. Регистрация нового пользователя

- **Endpoint:** `create_user`
- **Метод:** `POST`
- **URL:** `/api/v1/create_user`
- **Доступ:** `AllowAny` (для всех)
- **Описание:** Создает нового пользователя с ролью "студент".

- **Тело запроса (Body):**
  - `username` (string, **обязательно**) - Уникальное имя пользователя.
  - `password` (string, **обязательно**) - Паро��ь.

- **Пример тела запроса:**
```json
{
    "username": "new_student",
    "password": "strong_password_123"
}
```

- **Успешный ответ (Код 201 Created):**
  - Устанавливает `access_token` в cookie.
```json
{
    "message": "Пользователь успешно создан"
}
```

- **Возможные ошибки:**
  - **Код 400 Bad Request:** Если `username` уже занят или данные невалидны.

---

### 2. Авторизация (Вход)

- **Endpoint:** `authorization`
- **Метод:** `POST`
- **URL:** `/api/v1/authorization`
- **Доступ:** `AllowAny` (для всех)
- **Описание:** Аутентифицирует пользователя и возвращает токен доступа.

- **Тело запроса (Body):**
  - `username` (string, **обязательно**)
  - `password` (string, **обязательно**)

- **Пример тела запроса:**
```json
{
    "username": "existing_student",
    "password": "strong_password_123"
}
```

- **Успешный ответ (Код 200 OK):**
  - Устанавливает `access_token` в cookie.
```json
{
    "message": "Авторизация успешна"
}
```

- **Возможные ошибки:**
  - **Код 400 Bad Request:** Если предоставлены неверные учетные данные.

---

### 3. Выход из системы

- **Endpoint:** `logout`
- **Метод:** `POST`
- **URL:** `/api/v1/logout`
- **Доступ:** `IsAuthenticated` (для аутентифицированных пользователей)
- **Описание:** Удаляет `access_token` из cookie.

- **Успешный ответ (Код 200 OK):**
```json
{
    "message": "Выход выполнен успешно"
}
```

---

### 4. Получение информации о текущем пользователе

- **Endpoint:** `get_user_info`
- **Метод:** `GET`
- **URL:** `/api/v1/get_user_info`
- **Доступ:** `IsAuthenticated`
- **Описание:** Возвращает подробную информацию о пользователе, который делает запрос.

- **Успешный ответ (Код 200 OK):**
  - Возвращает объект пользователя, включая его заказы.
```json
{
    "id": 1,
    "username": "student1",
    "first_name": "Иван",
    "last_name": "Иванов",
    "role": "student",
    "canteen": null,
    "orders": [
        {
            "id": 12,
            "status": "closed",
            "created_at": "2025-07-03T10:00:00Z",
            "total_price": "250.00",
            "items": [
                {
                    "dish_name": "Салат 'Цезарь'",
                    "dish_price": "250.00",
                    "quantity": 1
                }
            ],
            "preparation_type": "asap",
            "preparation_time": null
        }
    ]
}
```

---

### 5. Обновление информации о пользователе

- **Endpoint:** `update_user`
- **Метод:** `PATCH` (или `PUT`)
- **URL:** `/api/v1/update_user`
- **Доступ:** `IsAuthenticated`
- **Описание:** Позволяет пользователю обновить свои данные.

- **Тело запроса (Body):**
  - `username` (string, *опционально*)
  - `first_name` (string, *опционально*)
  - `last_name` (string, *опционально*)

- **Пример тела запроса:**
```json
{
    "first_name": "Петр",
    "last_name": "Петров"
}
```

- **Успешный ответ (Код 200 OK):**
```json
{
    "message": "Данные пользователя успешно обновлены."
}
```

---

### 6. Получение списка столовых

- **Endpoint:** `canteens`
- **Метод:** `GET`
- **URL:** `/api/v1/canteens`
- **Доступ:** `AllowAny`
- **Описание:** Возвращает список всех доступных столовых.

- **Успешный ответ (Код 200 OK):**
  - Возвращает массив объектов столовых.
```json
[
    {
        "id": 1,
        "name": "Столовая на Несвкого",
        "address": "ул. Александра Невского, 14",
        "is_open": true
    },
    {
        "id": 2,
        "name": "Столовая на Озерова",
        "address": "ул. Генерал-Лейтенанта Озерова, 57",
        "is_open": false
    }
]
```

---

### 7. Получение меню для выбранной столовой

- **Endpoint:** `canteens/<canteen_id>/menu`
- **Метод:** `GET`
- **URL:** `/api/v1/canteens/1/menu` (где `1` - это ID столовой)
- **Доступ:** `AllowAny`
- **Описание:** Возвращает меню для конкретной столовой. Включает только блюда, которые есть в наличии (`quantity > 0`).

- **Успешный ответ (Код 200 OK):**
  - Возвращает массив объектов блюд с указанием доступного количества.
```json
[
    {
        "id": 1,
        "name": "Борщ",
        "description": "Классический борщ",
        "price": "150.00",
        "weight": 300,
        "photo": "/media/dishes/borsch.jpg",
        "available_quantity": 10
    }
]
```

---

### 8. Получение информации об одном блюде

- **Endpoint:** `canteens/<canteen_id>/menu/<dish_id>`
- **Метод:** `GET`
- **URL:** `/api/v1/canteens/1/menu/5` (где `1` - ID столовой, `5` - ID блюда)
- **Доступ:** `AllowAny`
- **Описание:** Возвращает подробную информацию о конкретном блюде в конкретной столовой.

- **Успешный ответ (Код 200 OK):**
```json
{
    "id": 5,
    "name": "Компот",
    "description": "Ягодный компот",
    "price": "50.00",
    "weight": 200,
    "photo": null,
    "available_quantity": 50
}
```

- **Возможные ошибки:**
  - **Код 404 Not Found:** Если блюдо или столовая не найдены.

---

### 9. Создание нового заказа

- **Endpoint:** `set_order`
- **Метод:** `POST`
- **URL:** `/api/v1/set_order`
- **Доступ:** `IsAuthenticated`
- **Описание:** Создает новый заказ.

- **Тело запроса (Body):**
  - `canteen_id` (integer, **обязательно**)
  - `preparation_type` (string, *опционально*, по умолч. `'asap'`) - `'asap'` или `'scheduled'`.
  - `preparation_time` (string, *опционально*) - `YYYY-MM-DDTHH:MM:SS`. Обязательно, если `preparation_type` = `'scheduled'`.
  - `items` (array, **обязательно**)
    - `dish_id` (integer, **обязательно**)
    - `quantity` (integer, **обязательно**)

- **Пример тела запроса:**
```json
{
    "canteen_id": 1,
    "preparation_type": "scheduled",
    "preparation_time": "2025-07-03T15:00:00",
    "items": [
        { "dish_id": 1, "quantity": 1 }
    ]
}
```

- **Успешный ответ (Код 201 Created):**
  - Возвращает полный объект созданного заказа.
```json
{
    "id": 16,
    "status": "paid",
    "created_at": "2025-07-03T12:45:00Z",
    "total_price": "150.00",
    "items": [
        {
            "dish_name": "Борщ",
            "dish_price": "150.00",
            "quantity": 1
        }
    ],
    "preparation_type": "scheduled",
    "preparation_time": "2025-07-03T15:00:00Z"
}
```

- **Возможные ошибки:**
  - **Код 400 Bad Request:** Неверные данные, или недостаточно блюд.
  - **Код 404 Not Found:** Столовая не найдена или закрыта.

---

## Раздел для работников столовой

### 10. Получение списка заказов

- **Endpoint:** `worker/orders`
- **Метод:** `GET`
- **URL:** `/api/v1/worker/orders`
- **Доступ:** `IsCanteenWorker` (только для работников столовой)
- **Описание:** Возвращает список активных заказов (`'new'`, `'paid'`) для столовой, к которой привязан работник. Заказы отсортированы по приоритету: сначала "как можно скорее", затем "ко времени" (по возрастанию времени).

- **Успешный ответ (Код 200 OK):**
  - Возвращает отсортированный массив объектов заказов.
```json
[
    {
        "id": 17,
        "status": "paid",
        "created_at": "2025-07-03T13:00:00Z",
        "total_price": "200.00",
        "items": [...],
        "preparation_type": "asap",
        "preparation_time": null
    },
    {
        "id": 16,
        "status": "paid",
        "created_at": "2025-07-03T12:45:00Z",
        "total_price": "150.00",
        "items": [...],
        "preparation_type": "scheduled",
        "preparation_time": "2025-07-03T15:00:00Z"
    }
]
```

---

### 11. Обновление статуса заказа

- **Endpoint:** `worker/orders/<order_id>/update-status`
- **Метод:** `PATCH`
- **URL:** `/api/v1/worker/orders/17/update-status`
- **Доступ:** `IsCanteenWorker`
- **Описание:** Позволяет работнику обновить статус заказа.

- **Тело запроса (Body):**
  - `status` (string, **обязательно**) - Новый статус. Доступные значения: `'ready'`, `'closed'`.

- **Пример тела запроса:**
```json
{
    "status": "ready"
}
```

- **Успешный ответ (Код 200 OK):**
  - Возвращает объект заказа с обновленным статусом.
```json
{
    "status": "ready"
}
```

- **Возможные ошибки:**
  - **Код 400 Bad Request:** Недопустимый статус.
  - **Код 404 Not Found:** Заказ не найден в столовой работника.
